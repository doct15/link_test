bmcgehee/link_test:
  Build:
    - echo "Nothing to build"
  PkgInclude:
    - '*'
  Env:
    - PROJECTDIR: "/home/bmcgehee/public_html/"
    - OWNER: "bmcgehee"
  PostInstall:
    - sudo chown -R $OWNER:$OWNER $DISTELLI_INSTALLHOME
    - sudo ln -sf $DISTELLI_INSTALLHOME/public_html/* $PROJECTDIR
    - sudo chown -R $OWNER:$OWNER $PROJECTDIR
    - if [ -f /distelli/last_distelli_install ]; then
    -    DISTELLI_LAST_INSTALLHOME=$(cat /distelli/last_distelli_install)
    - fi
    - echo -e "$DISTELLI_INSTALLHOME\c" > /distelli/last_distelli_install
    - cd $DISTELLI_LAST_INSTALLHOME
    - sudo rm -rf $DISTELLI_LAST_INSTALLHOME
    - cd $PROJECTDIR
    - sudo find . -type l -exec test ! -e '{}' \; -delete
    
    
    Not a sym link, copy contents to env directory
    create new temp symbolic link to that
    mv public_html to temp dir name
    mv temp symbolic link to public_html
    rm -rf temp dir name (old public_html)
    
dir=...
old=...
new=...

# [1] Link "new" files:
for f in $(find "$new" \! -type d | cut -b $((${#new}+2))-); do
    if ! [ -e "$dir/$f" ]; then
        mkdir -p $dir
        ln -s "$new/$f" "$dir/$f"
    fi
done
# [2] Rename symlinks into place and delete "old" symlinks:
for f in $(find "$dir" -type l -print0 | xargs -0 readlink | grep "^$old" | cut -b $((${#old}+2))-); do
   if ! [ -e "$new/$f" ]; then
       # Delete old symlink:
       rm -rf "$dir/$f"
   else
       # Relink, move link into place to make this
       # change atomically:
       ln -s "$new/$f" "$dir/.TEMP-LINK-$$"
       mv -f "$dir/.TEMP-LINK-$$" "$dir/$f"
   fi
done


